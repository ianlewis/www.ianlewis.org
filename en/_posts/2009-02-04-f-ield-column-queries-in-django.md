---
layout: post
title: "Field/column Queries in Django"
date: 2009-02-04 23:24:38 +0000
permalink: /en/f-ield-column-queries-in-django
blog: en
render_with_liquid: false
---

<p>One of the neat things making it's way into <a href="http://www.djangoproject.com/" title="Django">Django</a> 1.1 is <a href="http://docs.djangoproject.com/en/dev/topics/db/queries/#filters-can-reference-fields-on-the-model">F object queries</a>. The F object is kind of like the Q object as it can be used it queries but it represents a database field on the right hand side of an equality/inequality.</p>

<p>For the example I'll use the example models from the &quot;<a href="http://docs.djangoproject.com/en/dev/topics/db/queries/">Making Queries</a>&quot; section of the <a href="http://docs.djangoproject.com/en/dev/">Django Documentation</a>.

<div class="codeblock amc_python amc_long"><table><tr class="amc_code_odd"><td class="amc_line"><div class="amc1"></div></td><td><span style="color: #ff7700;font-weight:bold;">class</span> Blog<span style="color: black;">&#40;</span>models.<span style="color: black;">Model</span><span style="color: black;">&#41;</span>:<br /></td></tr><tr class="amc_code_even"><td class="amc_line"><div class="amc2"></div></td><td>&nbsp; &nbsp; name = models.<span style="color: black;">CharField</span><span style="color: black;">&#40;</span>max_length=<span style="color: #ff4500;">100</span><span style="color: black;">&#41;</span><br /></td></tr><tr class="amc_code_odd"><td class="amc_line"><div class="amc3"></div></td><td>&nbsp; &nbsp; tagline = models.<span style="color: black;">TextField</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span><br /></td></tr><tr class="amc_code_even"><td class="amc_line"><div class="amc4"></div></td><td><br /></td></tr><tr class="amc_code_odd"><td class="amc_line"><div class="amc5"></div></td><td>&nbsp; &nbsp; <span style="color: #ff7700;font-weight:bold;">def</span> <span style="color: #0000cd;">__unicode__</span><span style="color: black;">&#40;</span><span style="color: #008000;">self</span><span style="color: black;">&#41;</span>:<br /></td></tr><tr class="amc_code_even"><td class="amc_line"><div class="amc6"></div></td><td>&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ff7700;font-weight:bold;">return</span> <span style="color: #008000;">self</span>.<span style="color: black;">name</span><br /></td></tr><tr class="amc_code_odd"><td class="amc_line"><div class="amc7"></div></td><td><br /></td></tr><tr class="amc_code_even"><td class="amc_line"><div class="amc8"></div></td><td><span style="color: #ff7700;font-weight:bold;">class</span> Author<span style="color: black;">&#40;</span>models.<span style="color: black;">Model</span><span style="color: black;">&#41;</span>:<br /></td></tr><tr class="amc_code_odd"><td class="amc_line"><div class="amc9"></div></td><td>&nbsp; &nbsp; name = models.<span style="color: black;">CharField</span><span style="color: black;">&#40;</span>max_length=<span style="color: #ff4500;">50</span><span style="color: black;">&#41;</span><br /></td></tr><tr class="amc_code_even"><td class="amc_line"><div class="amc0"><div class="amc1"></div></div></td><td>&nbsp; &nbsp; <span style="color: #dc143c;">email</span> = models.<span style="color: black;">EmailField</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span><br /></td></tr><tr class="amc_code_odd"><td class="amc_line"><div class="amc1"><div class="amc1"></div></div></td><td><br /></td></tr><tr class="amc_code_even"><td class="amc_line"><div class="amc2"><div class="amc1"></div></div></td><td>&nbsp; &nbsp; <span style="color: #ff7700;font-weight:bold;">def</span> <span style="color: #0000cd;">__unicode__</span><span style="color: black;">&#40;</span><span style="color: #008000;">self</span><span style="color: black;">&#41;</span>:<br /></td></tr><tr class="amc_code_odd"><td class="amc_line"><div class="amc3"><div class="amc1"></div></div></td><td>&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ff7700;font-weight:bold;">return</span> <span style="color: #008000;">self</span>.<span style="color: black;">name</span><br /></td></tr><tr class="amc_code_even"><td class="amc_line"><div class="amc4"><div class="amc1"></div></div></td><td><br /></td></tr><tr class="amc_code_odd"><td class="amc_line"><div class="amc5"><div class="amc1"></div></div></td><td><span style="color: #ff7700;font-weight:bold;">class</span> Entry<span style="color: black;">&#40;</span>models.<span style="color: black;">Model</span><span style="color: black;">&#41;</span>:<br /></td></tr><tr class="amc_code_even"><td class="amc_line"><div class="amc6"><div class="amc1"></div></div></td><td>&nbsp; &nbsp; blog = models.<span style="color: black;">ForeignKey</span><span style="color: black;">&#40;</span>Blog<span style="color: black;">&#41;</span><br /></td></tr><tr class="amc_code_odd"><td class="amc_line"><div class="amc7"><div class="amc1"></div></div></td><td>&nbsp; &nbsp; headline = models.<span style="color: black;">CharField</span><span style="color: black;">&#40;</span>max_length=<span style="color: #ff4500;">255</span><span style="color: black;">&#41;</span><br /></td></tr><tr class="amc_code_even"><td class="amc_line"><div class="amc8"><div class="amc1"></div></div></td><td>&nbsp; &nbsp; body_text = models.<span style="color: black;">TextField</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span><br /></td></tr><tr class="amc_code_odd"><td class="amc_line"><div class="amc9"><div class="amc1"></div></div></td><td>&nbsp; &nbsp; pub_date = models.<span style="color: black;">DateTimeField</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span><br /></td></tr><tr class="amc_code_even"><td class="amc_line"><div class="amc0"><div class="amc2"></div></div></td><td>&nbsp; &nbsp; authors = models.<span style="color: black;">ManyToManyField</span><span style="color: black;">&#40;</span>Author<span style="color: black;">&#41;</span><br /></td></tr><tr class="amc_code_odd"><td class="amc_line"><div class="amc1"><div class="amc2"></div></div></td><td>&nbsp; &nbsp; n_comments = models.<span style="color: black;">IntegerField</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span><br /></td></tr><tr class="amc_code_even"><td class="amc_line"><div class="amc2"><div class="amc2"></div></div></td><td>&nbsp; &nbsp; n_pingbacks = models.<span style="color: black;">IntegerField</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span><br /></td></tr><tr class="amc_code_odd"><td class="amc_line"><div class="amc3"><div class="amc2"></div></div></td><td>&nbsp; &nbsp; rating = models.<span style="color: black;">IntegerField</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span><br /></td></tr><tr class="amc_code_even"><td class="amc_line"><div class="amc4"><div class="amc2"></div></div></td><td><br /></td></tr><tr class="amc_code_odd"><td class="amc_line"><div class="amc5"><div class="amc2"></div></div></td><td>&nbsp; &nbsp; <span style="color: #ff7700;font-weight:bold;">def</span> <span style="color: #0000cd;">__unicode__</span><span style="color: black;">&#40;</span><span style="color: #008000;">self</span><span style="color: black;">&#41;</span>:<br /></td></tr><tr class="amc_code_even"><td class="amc_line"><div class="amc6"><div class="amc2"></div></div></td><td>&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ff7700;font-weight:bold;">return</span> <span style="color: #008000;">self</span>.<span style="color: black;">headline</span></td></tr></table></div>

<p>Here we can do cool stuff like query for blog entries where the number of comments equals the number of pingbacks.</p>

<div class="codeblock amc_python amc_short"><table><tr class="amc_code_odd"><td class="amc_line"><div class="amc1"></div></td><td><span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #ff7700;font-weight:bold;">from</span> django.<span style="color: black;">db</span>.<span style="color: black;">models</span> <span style="color: #ff7700;font-weight:bold;">import</span> F<br /></td></tr><tr class="amc_code_even"><td class="amc_line"><div class="amc2"></div></td><td><span style="color: #66cc66;">&gt;&gt;&gt;</span> Entry.<span style="color: black;">objects</span>.<span style="color: #008000;">filter</span><span style="color: black;">&#40;</span>n_pingbacks__lt=F<span style="color: black;">&#40;</span><span style="color: #483d8b;">'n_comments'</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span></td></tr></table></div>

<p>You can perform operations on colums or add columns together.</p>

<div class="codeblock amc_python amc_short"><table><tr class="amc_code_odd"><td class="amc_line"><div class="amc1"></div></td><td><span style="color: #66cc66;">&gt;&gt;&gt;</span> Entry.<span style="color: black;">objects</span>.<span style="color: #008000;">filter</span><span style="color: black;">&#40;</span>n_pingbacks__lt=F<span style="color: black;">&#40;</span><span style="color: #483d8b;">'n_comments'</span><span style="color: black;">&#41;</span> <span style="color: #66cc66;">*</span> <span style="color: #ff4500;">2</span><span style="color: black;">&#41;</span><br /></td></tr><tr class="amc_code_even"><td class="amc_line"><div class="amc2"></div></td><td><span style="color: #66cc66;">&gt;&gt;&gt;</span> Entry.<span style="color: black;">objects</span>.<span style="color: #008000;">filter</span><span style="color: black;">&#40;</span>rating__lt=F<span style="color: black;">&#40;</span><span style="color: #483d8b;">'n_comments'</span><span style="color: black;">&#41;</span> + F<span style="color: black;">&#40;</span><span style="color: #483d8b;">'n_pingbacks'</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span></td></tr></table></div>

<p>You can even span relationships across tables</p>

<div class="codeblock amc_python amc_short"><table><tr class="amc_code_odd"><td class="amc_line"><div class="amc1"></div></td><td><span style="color: #66cc66;">&gt;&gt;&gt;</span> Entry.<span style="color: black;">objects</span>.<span style="color: #008000;">filter</span><span style="color: black;">&#40;</span>author__name=F<span style="color: black;">&#40;</span><span style="color: #483d8b;">'blog__name'</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span></td></tr></table></div>

<p>This query ended up like this. ftester is the name of the application I made to test this.</p>

<div class="codeblock amc_sql amc_short"><table><tr class="amc_code_odd"><td class="amc_line"><div class="amc1"></div></td><td><span style="color: #993333; font-weight: bold;">SELECT</span> <span style="color: #ff0000;">`ftester_entry`</span>.<span style="color: #ff0000;">`id`</span>, <span style="color: #ff0000;">`ftester_entry`</span>.<span style="color: #ff0000;">`blog_id`</span>, <span style="color: #ff0000;">`ftester_entry`</span>.<span style="color: #ff0000;">`headline`</span>, <span style="color: #ff0000;">`ftester_entry`</span>.<span style="color: #ff0000;">`body_text`</span>, <span style="color: #ff0000;">`ftester_entry`</span>.<span style="color: #ff0000;">`pub_date`</span>, <span style="color: #ff0000;">`ftester_entry`</span>.<span style="color: #ff0000;">`n_comments`</span>, <span style="color: #ff0000;">`ftester_entry`</span>.<span style="color: #ff0000;">`n_pingbacks`</span>, <span style="color: #ff0000;">`ftester_entry`</span>.<span style="color: #ff0000;">`rating`</span> <span style="color: #993333; font-weight: bold;">FROM</span> <span style="color: #ff0000;">`ftester_entry`</span> <span style="color: #993333; font-weight: bold;">INNER</span> <span style="color: #993333; font-weight: bold;">JOIN</span> <span style="color: #ff0000;">`ftester_blog`</span> <span style="color: #993333; font-weight: bold;">ON</span> <span style="color: #66cc66;">&#40;</span><span style="color: #ff0000;">`ftester_entry`</span>.<span style="color: #ff0000;">`blog_id`</span> <span style="color: #66cc66;">=</span> <span style="color: #ff0000;">`ftester_blog`</span>.<span style="color: #ff0000;">`id`</span><span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">INNER</span> <span style="color: #993333; font-weight: bold;">JOIN</span> <span style="color: #ff0000;">`ftester_entry_authors`</span> <span style="color: #993333; font-weight: bold;">ON</span> <span style="color: #66cc66;">&#40;</span><span style="color: #ff0000;">`ftester_entry`</span>.<span style="color: #ff0000;">`id`</span> <span style="color: #66cc66;">=</span> <span style="color: #ff0000;">`ftester_entry_authors`</span>.<span style="color: #ff0000;">`entry_id`</span><span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">INNER</span> <span style="color: #993333; font-weight: bold;">JOIN</span> <span style="color: #ff0000;">`ftester_author`</span> <span style="color: #993333; font-weight: bold;">ON</span> <span style="color: #66cc66;">&#40;</span><span style="color: #ff0000;">`ftester_entry_authors`</span>.<span style="color: #ff0000;">`author_id`</span> <span style="color: #66cc66;">=</span> <span style="color: #ff0000;">`ftester_author`</span>.<span style="color: #ff0000;">`id`</span><span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">WHERE</span> <span style="color: #ff0000;">`ftester_author`</span>.<span style="color: #ff0000;">`name`</span> <span style="color: #66cc66;">=</span> &nbsp;<span style="color: #ff0000;">`ftester_blog`</span>.<span style="color: #ff0000;">`name`</span> <span style="color: #993333; font-weight: bold;">LIMIT</span> <span style="color: #cc66cc;">21</span></td></tr></table></div>

<p><em>Note: As an aside it's interesting to note the limit on this query which actually only gets 21 records. I haven't tested it but I suppose that <a href="http://www.djangoproject.com/" title="Django">Django</a> only gets a set of records at a time for performance reasons.</em></p>

<p>But the reason the F() object was created was to allow using the value of one column in another column during an update. This allows you do do things like add 1 to the pingbacks for every entry in one go without selecting the whole batch and updating the field.</p>

<div class="codeblock amc_python amc_short"><table><tr class="amc_code_odd"><td class="amc_line"><div class="amc1"></div></td><td>Entry.<span style="color: black;">objects</span>.<span style="color: black;">all</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span>.<span style="color: black;">update</span><span style="color: black;">&#40;</span>n_pingbacks=F<span style="color: black;">&#40;</span><span style="color: #483d8b;">'n_pingbacks'</span><span style="color: black;">&#41;</span> + <span style="color: #ff4500;">1</span><span style="color: black;">&#41;</span></td></tr></table></div></p>
<div class="sharethis">
        <script type="text/javascript" language="javascript">
          SHARETHIS.addEntry( {
            title : 'Field/column Queries in Django',
              url   : 'http://www.ianlewis.org/en/f-ield-column-queries-in-django'}, 
            { button: true }
          ) ;
        </script></div>
