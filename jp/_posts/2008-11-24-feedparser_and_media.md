---
layout: post
title: "feedparserで、media コンテンツを取る"
date: 2008-11-24 21:12:30 +0000
permalink: /jp/feedparser_and_media
blog: jp
render_with_liquid: false
---

<p><a href="http://www.feedparser.org/">feedparser</a>で、どうやってビデオを取れるかをずっと悩みましたけど、今日少しだけ、進展した。問題の核心はyoutubeや、vimeoは <a href="http://search.yahoo.com/mrss/">Yahoo! RSS モジュール</a>を使って、RSS拡張ネームスペースにデータを入れている。この拡張データの処理はfeedparserが中途半端でやってる。見てみよう。</p>

<p>YoutubeのGDATA APIで取ったデータはこうなる</p>
<div class="codeblock amc_xml amc_long"><table><tr class="amc_code_odd"><td class="amc_line"><div class="amc1"></div></td><td>...<br /></td></tr><tr class="amc_code_even"><td class="amc_line"><div class="amc2"></div></td><td><span style="color: #009900;"><span style="font-weight: bold; color: black;">&lt;entry<span style="font-weight: bold; color: black;">&gt;</span></span></span><br /></td></tr><tr class="amc_code_odd"><td class="amc_line"><div class="amc3"></div></td><td>&nbsp; <span style="color: #009900;"><span style="font-weight: bold; color: black;">&lt;id<span style="font-weight: bold; color: black;">&gt;</span></span></span><a href="http://gdata.youtube.com/feeds/api/videos/R3orQKBxiEg">http://gdata.youtube.com/feeds/api/videos/R3orQKBxiEg</a><span style="color: #009900;"><span style="font-weight: bold; color: black;">&lt;/id<span style="font-weight: bold; color: black;">&gt;</span></span></span><br /></td></tr><tr class="amc_code_even"><td class="amc_line"><div class="amc4"></div></td><td>&nbsp; <span style="color: #009900;"><span style="font-weight: bold; color: black;">&lt;published<span style="font-weight: bold; color: black;">&gt;</span></span></span>2008-07-17T23:58:51.000Z<span style="color: #009900;"><span style="font-weight: bold; color: black;">&lt;/published<span style="font-weight: bold; color: black;">&gt;</span></span></span><br /></td></tr><tr class="amc_code_odd"><td class="amc_line"><div class="amc5"></div></td><td>&nbsp; <span style="color: #009900;"><span style="font-weight: bold; color: black;">&lt;updated<span style="font-weight: bold; color: black;">&gt;</span></span></span>2008-11-24T02:32:25.000Z<span style="color: #009900;"><span style="font-weight: bold; color: black;">&lt;/updated<span style="font-weight: bold; color: black;">&gt;</span></span></span><br /></td></tr><tr class="amc_code_even"><td class="amc_line"><div class="amc6"></div></td><td>&nbsp; ...<br /></td></tr><tr class="amc_code_odd"><td class="amc_line"><div class="amc7"></div></td><td>&nbsp; <span style="color: #009900;"><span style="font-weight: bold; color: black;">&lt;title</span> <span style="color: #000066;">type</span>=<span style="color: #ff0000;">&quot;text&quot;</span><span style="font-weight: bold; color: black;">&gt;</span></span>Official Watchmen Trailer<span style="color: #009900;"><span style="font-weight: bold; color: black;">&lt;/title<span style="font-weight: bold; color: black;">&gt;</span></span></span><br /></td></tr><tr class="amc_code_even"><td class="amc_line"><div class="amc8"></div></td><td>&nbsp; <span style="color: #009900;"><span style="font-weight: bold; color: black;">&lt;content</span> <span style="color: #000066;">type</span>=<span style="color: #ff0000;">&quot;text&quot;</span><span style="font-weight: bold; color: black;">&gt;</span></span>Title speaks for itself<br /></td></tr><tr class="amc_code_odd"><td class="amc_line"><div class="amc9"></div></td><td><br /></td></tr><tr class="amc_code_even"><td class="amc_line"><div class="amc0"><div class="amc1"></div></div></td><td>so people don't have to keep answerin <br /></td></tr><tr class="amc_code_odd"><td class="amc_line"><div class="amc1"><div class="amc1"></div></div></td><td>the name of the song is:<br /></td></tr><tr class="amc_code_even"><td class="amc_line"><div class="amc2"><div class="amc1"></div></div></td><td><br /></td></tr><tr class="amc_code_odd"><td class="amc_line"><div class="amc3"><div class="amc1"></div></div></td><td>smashing pumpkins- the beginning is the end is the beginning<span style="color: #009900;"><span style="font-weight: bold; color: black;">&lt;/content<span style="font-weight: bold; color: black;">&gt;</span></span></span><br /></td></tr><tr class="amc_code_even"><td class="amc_line"><div class="amc4"><div class="amc1"></div></div></td><td>&nbsp; &nbsp; ...<br /></td></tr><tr class="amc_code_odd"><td class="amc_line"><div class="amc5"><div class="amc1"></div></div></td><td>&nbsp; <span style="color: #009900;"><span style="font-weight: bold; color: black;">&lt;author<span style="font-weight: bold; color: black;">&gt;</span></span></span><br /></td></tr><tr class="amc_code_even"><td class="amc_line"><div class="amc6"><div class="amc1"></div></div></td><td>&nbsp; &nbsp; <span style="color: #009900;"><span style="font-weight: bold; color: black;">&lt;name<span style="font-weight: bold; color: black;">&gt;</span></span></span>Garrettheparrot<span style="color: #009900;"><span style="font-weight: bold; color: black;">&lt;/name<span style="font-weight: bold; color: black;">&gt;</span></span></span><br /></td></tr><tr class="amc_code_odd"><td class="amc_line"><div class="amc7"><div class="amc1"></div></div></td><td>&nbsp; &nbsp; <span style="color: #009900;"><span style="font-weight: bold; color: black;">&lt;uri<span style="font-weight: bold; color: black;">&gt;</span></span></span><a href="http://gdata.youtube.com/feeds/api/users/garrettheparrot">http://gdata.youtube.com/feeds/api/users/garrettheparrot</a><span style="color: #009900;"><span style="font-weight: bold; color: black;">&lt;/uri<span style="font-weight: bold; color: black;">&gt;</span></span></span><br /></td></tr><tr class="amc_code_even"><td class="amc_line"><div class="amc8"><div class="amc1"></div></div></td><td>&nbsp; <span style="color: #009900;"><span style="font-weight: bold; color: black;">&lt;/author<span style="font-weight: bold; color: black;">&gt;</span></span></span><br /></td></tr><tr class="amc_code_odd"><td class="amc_line"><div class="amc9"><div class="amc1"></div></div></td><td>&nbsp; <span style="color: #009900;"><span style="font-weight: bold; color: black;">&lt;media:group<span style="font-weight: bold; color: black;">&gt;</span></span></span><br /></td></tr><tr class="amc_code_even"><td class="amc_line"><div class="amc0"><div class="amc2"></div></div></td><td>&nbsp; &nbsp; <span style="color: #009900;"><span style="font-weight: bold; color: black;">&lt;media:title</span> <span style="color: #000066;">type</span>=<span style="color: #ff0000;">&quot;plain&quot;</span><span style="font-weight: bold; color: black;">&gt;</span></span>Official Watchmen Trailer<span style="color: #009900;"><span style="font-weight: bold; color: black;">&lt;/media:title<span style="font-weight: bold; color: black;">&gt;</span></span></span><br /></td></tr><tr class="amc_code_odd"><td class="amc_line"><div class="amc1"><div class="amc2"></div></div></td><td>&nbsp; &nbsp; <span style="color: #009900;"><span style="font-weight: bold; color: black;">&lt;media:description</span> <span style="color: #000066;">type</span>=<span style="color: #ff0000;">&quot;plain&quot;</span><span style="font-weight: bold; color: black;">&gt;</span></span>Title speaks for itself<br /></td></tr><tr class="amc_code_even"><td class="amc_line"><div class="amc2"><div class="amc2"></div></div></td><td><br /></td></tr><tr class="amc_code_odd"><td class="amc_line"><div class="amc3"><div class="amc2"></div></div></td><td>so people don't have to keep answerin <br /></td></tr><tr class="amc_code_even"><td class="amc_line"><div class="amc4"><div class="amc2"></div></div></td><td>the name of the song is:<br /></td></tr><tr class="amc_code_odd"><td class="amc_line"><div class="amc5"><div class="amc2"></div></div></td><td><br /></td></tr><tr class="amc_code_even"><td class="amc_line"><div class="amc6"><div class="amc2"></div></div></td><td>smashing pumpkins- the beginning is the end is the beginning<span style="color: #009900;"><span style="font-weight: bold; color: black;">&lt;/media:description<span style="font-weight: bold; color: black;">&gt;</span></span></span><br /></td></tr><tr class="amc_code_odd"><td class="amc_line"><div class="amc7"><div class="amc2"></div></div></td><td>&nbsp; &nbsp; <span style="color: #009900;"><span style="font-weight: bold; color: black;">&lt;media:keywords<span style="font-weight: bold; color: black;">&gt;</span></span></span>2009, Comic, Men, Movie, Watch, Watches, Who<span style="color: #009900;"><span style="font-weight: bold; color: black;">&lt;/media:keywords<span style="font-weight: bold; color: black;">&gt;</span></span></span><br /></td></tr><tr class="amc_code_even"><td class="amc_line"><div class="amc8"><div class="amc2"></div></div></td><td>&nbsp; &nbsp; <span style="color: #009900;"><span style="font-weight: bold; color: black;">&lt;yt:duration</span> <span style="color: #000066;">seconds</span>=<span style="color: #ff0000;">&quot;140&quot;</span><span style="font-weight: bold; color: black;">/&gt;</span></span><br /></td></tr><tr class="amc_code_odd"><td class="amc_line"><div class="amc9"><div class="amc2"></div></div></td><td>&nbsp; &nbsp; <span style="color: #009900;"><span style="font-weight: bold; color: black;">&lt;media:category</span> <span style="color: #000066;">label</span>=<span style="color: #ff0000;">&quot;Film &amp;amp; Animation&quot;</span> <span style="color: #000066;">scheme</span>=<span style="color: #ff0000;">&quot;http://gdata.youtube.com/schemas/2007/categories.cat&quot;</span><span style="font-weight: bold; color: black;">&gt;</span></span>Film<span style="color: #009900;"><span style="font-weight: bold; color: black;">&lt;/media:category<span style="font-weight: bold; color: black;">&gt;</span></span></span><br /></td></tr><tr class="amc_code_even"><td class="amc_line"><div class="amc0"><div class="amc3"></div></div></td><td>&nbsp; &nbsp; <span style="color: #009900;"><span style="font-weight: bold; color: black;">&lt;media:content</span> <span style="color: #000066;">url</span>=<span style="color: #ff0000;">&quot;http://www.youtube.com/v/R3orQKBxiEg&amp;amp;f=gdata_user_favorites&quot;</span> <span style="color: #000066;">type</span>=<span style="color: #ff0000;">&quot;application/x-shockwave-flash&quot;</span> <span style="color: #000066;">medium</span>=<span style="color: #ff0000;">&quot;video&quot;</span> <span style="color: #000066;">isDefault</span>=<span style="color: #ff0000;">&quot;true&quot;</span> <span style="color: #000066;">expression</span>=<span style="color: #ff0000;">&quot;full&quot;</span> <span style="color: #000066;">duration</span>=<span style="color: #ff0000;">&quot;140&quot;</span> <span style="color: #000066;">yt:format</span>=<span style="color: #ff0000;">&quot;5&quot;</span><span style="font-weight: bold; color: black;">/&gt;</span></span><br /></td></tr><tr class="amc_code_odd"><td class="amc_line"><div class="amc1"><div class="amc3"></div></div></td><td>&nbsp; &nbsp; <span style="color: #009900;"><span style="font-weight: bold; color: black;">&lt;media:content</span> <span style="color: #000066;">url</span>=<span style="color: #ff0000;">&quot;rtsp://rtsp2.youtube.com/CjALENy73wIaJwlIiHGgQCt6RxMYDSANFEgGUhRnZGF0YV91c2VyX2Zhdm9yaXRlcww=/0/0/0/video.3gp&quot;</span> <span style="color: #000066;">type</span>=<span style="color: #ff0000;">&quot;video/3gpp&quot;</span> <span style="color: #000066;">medium</span>=<span style="color: #ff0000;">&quot;video&quot;</span> <span style="color: #000066;">expression</span>=<span style="color: #ff0000;">&quot;full&quot;</span> <span style="color: #000066;">duration</span>=<span style="color: #ff0000;">&quot;140&quot;</span> <span style="color: #000066;">yt:format</span>=<span style="color: #ff0000;">&quot;1&quot;</span><span style="font-weight: bold; color: black;">/&gt;</span></span><br /></td></tr><tr class="amc_code_even"><td class="amc_line"><div class="amc2"><div class="amc3"></div></div></td><td>&nbsp; &nbsp; <span style="color: #009900;"><span style="font-weight: bold; color: black;">&lt;media:content</span> <span style="color: #000066;">url</span>=<span style="color: #ff0000;">&quot;rtsp://rtsp2.youtube.com/CjALENy73wIaJwlIiHGgQCt6RxMYESARFEgGUhRnZGF0YV91c2VyX2Zhdm9yaXRlcww=/0/0/0/video.3gp&quot;</span> <span style="color: #000066;">type</span>=<span style="color: #ff0000;">&quot;video/3gpp&quot;</span> <span style="color: #000066;">medium</span>=<span style="color: #ff0000;">&quot;video&quot;</span> <span style="color: #000066;">expression</span>=<span style="color: #ff0000;">&quot;full&quot;</span> <span style="color: #000066;">duration</span>=<span style="color: #ff0000;">&quot;140&quot;</span> <span style="color: #000066;">yt:format</span>=<span style="color: #ff0000;">&quot;6&quot;</span><span style="font-weight: bold; color: black;">/&gt;</span></span><br /></td></tr><tr class="amc_code_odd"><td class="amc_line"><div class="amc3"><div class="amc3"></div></div></td><td>&nbsp; &nbsp; <span style="color: #009900;"><span style="font-weight: bold; color: black;">&lt;media:thumbnail</span> <span style="color: #000066;">url</span>=<span style="color: #ff0000;">&quot;http://i.ytimg.com/vi/R3orQKBxiEg/2.jpg&quot;</span> <span style="color: #000066;">height</span>=<span style="color: #ff0000;">&quot;97&quot;</span> <span style="color: #000066;">width</span>=<span style="color: #ff0000;">&quot;130&quot;</span> <span style="color: #000066;">time</span>=<span style="color: #ff0000;">&quot;00:01:10&quot;</span><span style="font-weight: bold; color: black;">/&gt;</span></span><br /></td></tr><tr class="amc_code_even"><td class="amc_line"><div class="amc4"><div class="amc3"></div></div></td><td>&nbsp; &nbsp; <span style="color: #009900;"><span style="font-weight: bold; color: black;">&lt;media:thumbnail</span> <span style="color: #000066;">url</span>=<span style="color: #ff0000;">&quot;http://i.ytimg.com/vi/R3orQKBxiEg/1.jpg&quot;</span> <span style="color: #000066;">height</span>=<span style="color: #ff0000;">&quot;97&quot;</span> <span style="color: #000066;">width</span>=<span style="color: #ff0000;">&quot;130&quot;</span> <span style="color: #000066;">time</span>=<span style="color: #ff0000;">&quot;00:00:35&quot;</span><span style="font-weight: bold; color: black;">/&gt;</span></span><br /></td></tr><tr class="amc_code_odd"><td class="amc_line"><div class="amc5"><div class="amc3"></div></div></td><td>&nbsp; &nbsp; <span style="color: #009900;"><span style="font-weight: bold; color: black;">&lt;media:thumbnail</span> <span style="color: #000066;">url</span>=<span style="color: #ff0000;">&quot;http://i.ytimg.com/vi/R3orQKBxiEg/3.jpg&quot;</span> <span style="color: #000066;">height</span>=<span style="color: #ff0000;">&quot;97&quot;</span> <span style="color: #000066;">width</span>=<span style="color: #ff0000;">&quot;130&quot;</span> <span style="color: #000066;">time</span>=<span style="color: #ff0000;">&quot;00:01:45&quot;</span><span style="font-weight: bold; color: black;">/&gt;</span></span><br /></td></tr><tr class="amc_code_even"><td class="amc_line"><div class="amc6"><div class="amc3"></div></div></td><td>&nbsp; &nbsp; <span style="color: #009900;"><span style="font-weight: bold; color: black;">&lt;media:thumbnail</span> <span style="color: #000066;">url</span>=<span style="color: #ff0000;">&quot;http://i.ytimg.com/vi/R3orQKBxiEg/0.jpg&quot;</span> <span style="color: #000066;">height</span>=<span style="color: #ff0000;">&quot;240&quot;</span> <span style="color: #000066;">width</span>=<span style="color: #ff0000;">&quot;320&quot;</span> <span style="color: #000066;">time</span>=<span style="color: #ff0000;">&quot;00:01:10&quot;</span><span style="font-weight: bold; color: black;">/&gt;</span></span><br /></td></tr><tr class="amc_code_odd"><td class="amc_line"><div class="amc7"><div class="amc3"></div></div></td><td>&nbsp; &nbsp; <span style="color: #009900;"><span style="font-weight: bold; color: black;">&lt;media:player</span> <span style="color: #000066;">url</span>=<span style="color: #ff0000;">&quot;http://www.youtube.com/watch?v=R3orQKBxiEg&quot;</span><span style="font-weight: bold; color: black;">/&gt;</span></span><br /></td></tr><tr class="amc_code_even"><td class="amc_line"><div class="amc8"><div class="amc3"></div></div></td><td>&nbsp; <span style="color: #009900;"><span style="font-weight: bold; color: black;">&lt;/media:group<span style="font-weight: bold; color: black;">&gt;</span></span></span><br /></td></tr><tr class="amc_code_odd"><td class="amc_line"><div class="amc9"><div class="amc3"></div></div></td><td>&nbsp; ...<br /></td></tr><tr class="amc_code_even"><td class="amc_line"><div class="amc0"><div class="amc4"></div></div></td><td><span style="color: #009900;"><span style="font-weight: bold; color: black;">&lt;/entry<span style="font-weight: bold; color: black;">&gt;</span></span></span><br /></td></tr><tr class="amc_code_odd"><td class="amc_line"><div class="amc1"><div class="amc4"></div></div></td><td>...</td></tr></table></div>

<p>media という名前空間の下に結構データが入ってる。なのに、feedparserはちょっとしか取らない。</p>

<div class="codeblock amc_python amc_short"><table><tr class="amc_code_odd"><td class="amc_line"><div class="amc1"></div></td><td><span style="color: #66cc66;">&gt;&gt;&gt;</span> d = feedparser.<span style="color: black;">parse</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;http://gdata.youtube.com/feeds/api/users/IanLewisInJapan/favorites&quot;</span><span style="color: black;">&#41;</span><br /></td></tr><tr class="amc_code_even"><td class="amc_line"><div class="amc2"></div></td><td><span style="color: #66cc66;">&gt;&gt;&gt;</span> e = d<span style="color: black;">&#91;</span><span style="color: #483d8b;">'entries'</span><span style="color: black;">&#93;</span><span style="color: black;">&#91;</span><span style="color: #ff4500;">0</span><span style="color: black;">&#93;</span><br /></td></tr><tr class="amc_code_odd"><td class="amc_line"><div class="amc3"></div></td><td><span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #008000;">filter</span><span style="color: black;">&#40;</span><span style="color: #ff7700;font-weight:bold;">lambda</span> x: x.<span style="color: black;">startswith</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'media_'</span><span style="color: black;">&#41;</span>, e.<span style="color: black;">keys</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span><br /></td></tr><tr class="amc_code_even"><td class="amc_line"><div class="amc4"></div></td><td><span style="color: black;">&#91;</span><span style="color: #483d8b;">'media_category'</span>, <span style="color: #483d8b;">'media_player'</span>, <span style="color: #483d8b;">'media_group'</span>, <span style="color: #483d8b;">'media_keywords'</span>, <span style="color: #483d8b;">'media_description'</span>, <span style="color: #483d8b;">'media_content'</span>, <span style="color: #483d8b;">'media_thumbnail'</span><span style="color: black;">&#93;</span><br /></td></tr><tr class="amc_code_odd"><td class="amc_line"><div class="amc5"></div></td><td><span style="color: #66cc66;">&gt;&gt;&gt;</span> e<span style="color: black;">&#91;</span><span style="color: #483d8b;">'media_content'</span><span style="color: black;">&#93;</span><br /></td></tr><tr class="amc_code_even"><td class="amc_line"><div class="amc6"></div></td><td>u<span style="color: #483d8b;">''</span><br /></td></tr><tr class="amc_code_odd"><td class="amc_line"><div class="amc7"></div></td><td><span style="color: #66cc66;">&gt;&gt;&gt;</span> e<span style="color: black;">&#91;</span><span style="color: #483d8b;">'media_thumbnail'</span><span style="color: black;">&#93;</span><br /></td></tr><tr class="amc_code_even"><td class="amc_line"><div class="amc8"></div></td><td>u<span style="color: #483d8b;">''</span><br /></td></tr><tr class="amc_code_odd"><td class="amc_line"><div class="amc9"></div></td><td><span style="color: #66cc66;">&gt;&gt;&gt;</span> e<span style="color: black;">&#91;</span><span style="color: #483d8b;">'media_player'</span><span style="color: black;">&#93;</span><br /></td></tr><tr class="amc_code_even"><td class="amc_line"><div class="amc0"><div class="amc1"></div></div></td><td>u<span style="color: #483d8b;">''</span><br /></td></tr><tr class="amc_code_odd"><td class="amc_line"><div class="amc1"><div class="amc1"></div></div></td><td><span style="color: #66cc66;">&gt;&gt;&gt;</span> e<span style="color: black;">&#91;</span><span style="color: #483d8b;">'media_description'</span><span style="color: black;">&#93;</span><br /></td></tr><tr class="amc_code_even"><td class="amc_line"><div class="amc2"><div class="amc1"></div></div></td><td>u<span style="color: #483d8b;">'Last.fm/presents Yellow Magic Orchestra Interview at Royal Festival Hall in London.<span style="color: #000099; font-weight: bold;">\n</span>Check out <a href="http://www.last.fm/Presents">http://www.last.fm/Presents</a> to find out about all of our other interviews or upcoming/past events.'</span><br /></td></tr><tr class="amc_code_odd"><td class="amc_line"><div class="amc3"><div class="amc1"></div></div></td><td><span style="color: #66cc66;">&gt;&gt;&gt;</span></td></tr></table></div>

<p>ビデオのURLはどこかにない。原因はfeedparserの拡張ネームスペース処理に入ってるけども、一言いうと、&lt;media:content&gt;というタグの属性は取れてない。こう見たら、どうやって、とれるかを調べたら、unknown_starttag()というメソッドの中にこのコードを見つけた。</p>

<h4>feedparser.py</h4>

<div class="codeblock amc_python amc_short"><table><tr class="amc_code_odd"><td class="amc_line"><div class="amc1"></div></td><td>...<br /></td></tr><tr class="amc_code_even"><td class="amc_line"><div class="amc2"></div></td><td><span style="color: #808080; font-style: italic;"># call special handler (if defined) or default handler</span><br /></td></tr><tr class="amc_code_odd"><td class="amc_line"><div class="amc3"></div></td><td>methodname = <span style="color: #483d8b;">'_start_'</span> + prefix + suffix<br /></td></tr><tr class="amc_code_even"><td class="amc_line"><div class="amc4"></div></td><td><span style="color: #ff7700;font-weight:bold;">try</span>:<br /></td></tr><tr class="amc_code_odd"><td class="amc_line"><div class="amc5"></div></td><td>&nbsp; method = <span style="color: #008000;">getattr</span><span style="color: black;">&#40;</span><span style="color: #008000;">self</span>, methodname<span style="color: black;">&#41;</span><br /></td></tr><tr class="amc_code_even"><td class="amc_line"><div class="amc6"></div></td><td>&nbsp; <span style="color: #ff7700;font-weight:bold;">return</span> method<span style="color: black;">&#40;</span>attrsD<span style="color: black;">&#41;</span><br /></td></tr><tr class="amc_code_odd"><td class="amc_line"><div class="amc7"></div></td><td><span style="color: #ff7700;font-weight:bold;">except</span> <span style="color: #008000;">AttributeError</span>:<br /></td></tr><tr class="amc_code_even"><td class="amc_line"><div class="amc8"></div></td><td>&nbsp; <span style="color: #ff7700;font-weight:bold;">return</span> <span style="color: #008000;">self</span>.<span style="color: black;">push</span><span style="color: black;">&#40;</span>prefix + suffix, <span style="color: #ff4500;">1</span><span style="color: black;">&#41;</span><br /></td></tr><tr class="amc_code_odd"><td class="amc_line"><div class="amc9"></div></td><td>...</td></tr></table></div>

<p>じゃ、<a href="http://en.wikipedia.org/wiki/XML" title="XML">XML</a>を解析するときに、タグを見つけたら、unknown_starttag()という関数が実行されて、タグの名前に一致するメソッドがあれば、実行する処理やってる。それで、start_media_content()というメソッドがあれば実行してくれるわけだね。でも、どうやって、パーサークラスに付けるのか。feedparserは_StrictFeedParserというクラスを名前で使ってるから、自分が作ったクラスを_ScrictFeedParserと交換。</p>

<div class="codeblock amc_python amc_short"><table><tr class="amc_code_odd"><td class="amc_line"><div class="amc1"></div></td><td>feedparser._StrictFeedParser_old = feedparser._StrictFeedParser<br /></td></tr><tr class="amc_code_even"><td class="amc_line"><div class="amc2"></div></td><td><span style="color: #ff7700;font-weight:bold;">class</span> DlifeFeedParser<span style="color: black;">&#40;</span>feedparser._StrictFeedParser_old<span style="color: black;">&#41;</span>:<br /></td></tr><tr class="amc_code_odd"><td class="amc_line"><div class="amc3"></div></td><td>&nbsp; <br /></td></tr><tr class="amc_code_even"><td class="amc_line"><div class="amc4"></div></td><td>&nbsp; <span style="color: #ff7700;font-weight:bold;">def</span> _start_media_content<span style="color: black;">&#40;</span><span style="color: #008000;">self</span>, attrsD<span style="color: black;">&#41;</span>:<br /></td></tr><tr class="amc_code_odd"><td class="amc_line"><div class="amc5"></div></td><td>&nbsp; &nbsp; <span style="color: #008000;">self</span>.<span style="color: black;">entries</span><span style="color: black;">&#91;</span><span style="color: #ff4500;">-1</span><span style="color: black;">&#93;</span><span style="color: black;">&#91;</span><span style="color: #483d8b;">'media_content_attrs'</span><span style="color: black;">&#93;</span> = <span style="color: #dc143c;">copy</span>.<span style="color: black;">deepcopy</span><span style="color: black;">&#40;</span>attrsD<span style="color: black;">&#41;</span><br /></td></tr><tr class="amc_code_even"><td class="amc_line"><div class="amc6"></div></td><td>feedparser._StrictFeedParser = DlifeFeedParser</td></tr></table></div>

<p>それで、またparse()を実行すると、</p>

<div class="codeblock amc_python amc_short"><table><tr class="amc_code_odd"><td class="amc_line"><div class="amc1"></div></td><td><span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #ff7700;font-weight:bold;">import</span> feedparser<br /></td></tr><tr class="amc_code_even"><td class="amc_line"><div class="amc2"></div></td><td><span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #ff7700;font-weight:bold;">import</span> <span style="color: #dc143c;">copy</span><br /></td></tr><tr class="amc_code_odd"><td class="amc_line"><div class="amc3"></div></td><td><span style="color: #66cc66;">&gt;&gt;&gt;</span> feedparser._StrictFeedParser_old = feedparser._StrictFeedParser<br /></td></tr><tr class="amc_code_even"><td class="amc_line"><div class="amc4"></div></td><td><span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #ff7700;font-weight:bold;">class</span> DlifeFeedParser<span style="color: black;">&#40;</span>feedparser._StrictFeedParser_old<span style="color: black;">&#41;</span>:<br /></td></tr><tr class="amc_code_odd"><td class="amc_line"><div class="amc5"></div></td><td>... &nbsp; &nbsp; &nbsp; <br /></td></tr><tr class="amc_code_even"><td class="amc_line"><div class="amc6"></div></td><td>... &nbsp; <span style="color: #ff7700;font-weight:bold;">def</span> _start_media_content<span style="color: black;">&#40;</span><span style="color: #008000;">self</span>, attrsD<span style="color: black;">&#41;</span>:<br /></td></tr><tr class="amc_code_odd"><td class="amc_line"><div class="amc7"></div></td><td>... &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #008000;">self</span>.<span style="color: black;">entries</span><span style="color: black;">&#91;</span><span style="color: #ff4500;">-1</span><span style="color: black;">&#93;</span><span style="color: black;">&#91;</span><span style="color: #483d8b;">'media_content_attrs'</span><span style="color: black;">&#93;</span> = <span style="color: #dc143c;">copy</span>.<span style="color: black;">deepcopy</span><span style="color: black;">&#40;</span>attrsD<span style="color: black;">&#41;</span><br /></td></tr><tr class="amc_code_even"><td class="amc_line"><div class="amc8"></div></td><td>... &nbsp; &nbsp; <span style="color: #ff7700;font-weight:bold;">return</span> <span style="color: #008000;">self</span>.<span style="color: black;">push</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">'media_content'</span>, <span style="color: #ff4500;">1</span><span style="color: black;">&#41;</span><br /></td></tr><tr class="amc_code_odd"><td class="amc_line"><div class="amc9"></div></td><td>... <br /></td></tr><tr class="amc_code_even"><td class="amc_line"><div class="amc0"><div class="amc1"></div></div></td><td><span style="color: #66cc66;">&gt;&gt;&gt;</span> feedparser._StrictFeedParser = DlifeFeedParser<br /></td></tr><tr class="amc_code_odd"><td class="amc_line"><div class="amc1"><div class="amc1"></div></div></td><td><span style="color: #66cc66;">&gt;&gt;&gt;</span> d = feedparser.<span style="color: black;">parse</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;http://gdata.youtube.com/feeds/api/users/IanLewisInJapan/favorites&quot;</span><span style="color: black;">&#41;</span><br /></td></tr><tr class="amc_code_even"><td class="amc_line"><div class="amc2"><div class="amc1"></div></div></td><td><span style="color: #66cc66;">&gt;&gt;&gt;</span> <span style="color: #008000;">filter</span><span style="color: black;">&#40;</span><span style="color: #ff7700;font-weight:bold;">lambda</span> x: x.<span style="color: black;">startswith</span><span style="color: black;">&#40;</span><span style="color: #483d8b;">&quot;media_&quot;</span><span style="color: black;">&#41;</span>, d<span style="color: black;">&#91;</span><span style="color: #483d8b;">'entries'</span><span style="color: black;">&#93;</span><span style="color: black;">&#91;</span><span style="color: #ff4500;">0</span><span style="color: black;">&#93;</span>.<span style="color: black;">keys</span><span style="color: black;">&#40;</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span><br /></td></tr><tr class="amc_code_odd"><td class="amc_line"><div class="amc3"><div class="amc1"></div></div></td><td><span style="color: black;">&#91;</span><span style="color: #483d8b;">'media_category'</span>, <span style="color: #483d8b;">'media_player'</span>, <span style="color: #483d8b;">'media_group'</span>, <span style="color: #483d8b;">'media_content_attrs'</span>, <span style="color: #483d8b;">'media_keywords'</span>, <span style="color: #483d8b;">'media_description'</span>, <span style="color: #483d8b;">'media_content'</span>, <span style="color: #483d8b;">'media_thumbnail'</span><span style="color: black;">&#93;</span><br /></td></tr><tr class="amc_code_even"><td class="amc_line"><div class="amc4"><div class="amc1"></div></div></td><td><span style="color: #66cc66;">&gt;&gt;&gt;</span> d<span style="color: black;">&#91;</span><span style="color: #483d8b;">'entries'</span><span style="color: black;">&#93;</span><span style="color: black;">&#91;</span><span style="color: #ff4500;">0</span><span style="color: black;">&#93;</span><span style="color: black;">&#91;</span><span style="color: #483d8b;">'media_content_attrs'</span><span style="color: black;">&#93;</span><br /></td></tr><tr class="amc_code_odd"><td class="amc_line"><div class="amc5"><div class="amc1"></div></div></td><td><span style="color: black;">&#91;</span><span style="color: #483d8b;">'medium'</span>, <span style="color: #483d8b;">'format'</span>, <span style="color: #483d8b;">'url'</span>, <span style="color: #483d8b;">'expression'</span>, <span style="color: #483d8b;">'duration'</span>, <span style="color: #483d8b;">'type'</span>, <span style="color: #483d8b;">'yt:format'</span><span style="color: black;">&#93;</span></td></tr></table></div>

<p>それで、media:contentの属性を取れた。　media:groupの下にcontentが複数ある場合もあるから、もうちょっとまとめないといけないけど、やり方が少し分かってきた。</p>
<div class="sharethis">
        <script type="text/javascript" language="javascript">
          SHARETHIS.addEntry( {
            title : 'feedparserで、media コンテンツを取る',
              url   : 'http://www.ianlewis.org/jp/feedparser_and_media'}, 
            { button: true }
          ) ;
        </script></div>
